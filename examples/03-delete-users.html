<p class="description">
  Delete users having a name that starts with "rocksse-example". We demonstrate
  two things:
</p>
<ol>
  <li>Log message to textarea</li>
  <li>Show progressbar</li>
</ol>
{buttons}
<textarea
  class="uk-textarea log uk-margin-top"
  rows="5"
></textarea>
<div
  class="uk-flex uk-flex-middle"
  style="gap: 20px"
>
  <span
    class="uk-text-nowrap uk-text-small"
    style="font-family: monospace"
  >
    <span class="num">0</span> /
    <span class="total">0</span>
  </span>
  <progress class="uk-progress"></progress>
</div>
<script>
  (() => {
    let conn = false;
    let isRunning = false;
    const li = document.currentScript.closest("li.Inputfield");
    const start = li.querySelector(".start");
    const stop = li.querySelector(".stop");
    const log = li.querySelector(".log");
    const num = li.querySelector(".num");
    const total = li.querySelector(".total");
    const progress = li.querySelector("progress");

    // function to log a message to the textarea
    const logMsg = function (msg) {
      log.value = msg + "\n" + log.value;
    };

    // function to update progress
    const updateProgress = function (data) {
      if (!data) return;
      setProgress(data.num, data.total);
    };
    const setProgress = function (newNum, newTotal) {
      num.innerText = newNum;
      total.innerText = newTotal;
      if (!newTotal) progress.value = 0;
      else progress.value = newNum / newTotal;
    };

    // handle clicks on start button
    start.addEventListener("click", (e) => {
      // prevent starting stream more than once
      if (isRunning) return;
      isRunning = true;

      setProgress(0, 0);

      // start stream and update the conn variable
      conn = RockSSE.start({
        url: "/examples/delete-users",
        onmessage: (msg) => {
          // if data is a json object we received the iterator
          // and we can update the progressbar
          updateProgress(RockSSE.getJSON(msg));

          // always log message to textarea
          logMsg(msg);
        },
        onerror: (event) => {
          isRunning = false;
        },
        ondone: () => {
          isRunning = false;
        },
      });
    });

    // handle clicks on stop button
    stop.addEventListener("click", (e) => {
      setProgress(0, 0);
      if (!isRunning) return;
      isRunning = false;
      conn.close();
      logMsg("Connection closed");
    });
  })();
</script>
