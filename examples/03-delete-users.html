<p class="description">
  Delete users having a name that starts with "rocksse-example". We demonstrate
  two things:
</p>
<ol>
  <li>Log message to textarea</li>
  <li>Show progressbar</li>
</ol>
{buttons}
<textarea
  class="uk-textarea log uk-margin-top"
  rows="5"
></textarea>
<div
  class="uk-flex uk-flex-middle"
  style="gap: 20px"
>
  <span
    class="uk-text-nowrap uk-text-small"
    style="font-family: monospace"
  >
    <span class="num">0</span> /
    <span class="total">0</span>
  </span>
  <progress class="uk-progress"></progress>
</div>
<script>
  (() => {
    const stream = RockSSE.addStream("/examples/delete-users");

    // dom elements
    const li = document.currentScript.closest("li.Inputfield");
    const start = li.querySelector(".start");
    const stop = li.querySelector(".stop");
    const log = li.querySelector(".log");
    const num = li.querySelector(".num");
    const total = li.querySelector(".total");
    const progress = li.querySelector("progress");

    // helper functions
    const setProgress = (newNum, newTotal) => {
      num.innerText = newNum;
      total.innerText = newTotal;
      if (!newTotal) progress.value = 0;
      else progress.value = newNum / newTotal;
    };

    // handle clicks on start button
    start.addEventListener("click", stream.start.bind(stream));

    // handle clicks on stop button
    stop.addEventListener("click", stream.stop.bind(stream));

    // setup stream
    stream.debug = true;
    stream.onmessage = (event) => {
      // try to parse JSON from the message
      const json = stream.getJSON(event.data);
      if (json) {
        // if we got JSON data update the progress
        if (json.num !== undefined && json.total !== undefined) {
          setProgress(json.num, json.total);
        }
      }
      // always log the message
      log.value = event.data + "\n" + log.value;
    };

    stream.stopped = () => {
      stream.message("Connection closed");
      setProgress(0, 0);
    };
  })();
</script>
