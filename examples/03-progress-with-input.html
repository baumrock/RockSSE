<p class="description">
  Dealing with user input makes things more complicated! SSE is by design a one
  way road. We can only receive data from the server, but we can not send
  data.<br />
  To overcome this limitation RockSSE sends a POST request to the server and
  after that starts the stream.
</p>
<table>
  <tr>
    <td style="padding-right: 10px">Step size:</td>
    <td>
      <input
        type="number"
        name="step"
        style="width: 200px"
      />
    </td>
  </tr>
  <tr>
    <td>Max:</td>
    <td>
      <input
        type="number"
        name="max"
        style="width: 200px"
      />
    </td>
  </tr>
</table>
<div class="uk-flex uk-flex-middle">
  <div class="uk-text-nowrap">
    <button
      id="start-progress-03"
      class="ui-button"
      type="button"
    >
      <i class="fa fa-play uk-margin-small-right"></i>
      Start
    </button>
    <button
      id="stop-progress-03"
      class="ui-button ui-priority-secondary uk-margin-right"
      type="button"
    >
      <i class="fa fa-stop uk-margin-small-right"></i>
      Stop
    </button>
  </div>
  <div
    class="uk-flex uk-flex-middle uk-width-1-1"
    style="gap: 20px"
  >
    <span> <span id="current-03">0</span>/<span id="max">0</span> </span>
    <progress
      id="progress-03"
      class="uk-progress"
      value=""
      max="1"
    ></progress>
  </div>
</div>
<p class="notes uk-margin-remove-bottom">
  For simplicity we hardcoded all values in this example!
</p>
<script>
  (() => {
    let isRunning = false;
    const start = document.querySelector("#start-progress-03");
    const stop = document.querySelector("#stop-progress-03");
    const current = document.querySelector("#current-03");
    const max = document.querySelector("#max");
    const progress = document.querySelector("#progress-03");
    const stepInput = document.querySelector("input[name=step]");
    const maxInput = document.querySelector("input[name=max]");
    let conn = false;
    let maxValue;

    // monitor input changes
    const updateMax = (val) => {
      max.innerText = maxValue = maxInput.value || val;
    };
    maxInput.addEventListener("change", updateMax);
    maxInput.addEventListener("input", updateMax);
    updateMax(100);

    // handle clicks on start button
    start.addEventListener("click", (e) => {
      // prevent starting stream more than once
      if (isRunning) return;
      isRunning = true;

      // start stream and update the conn variable
      RockSSE.post({
        foo: "bar",
      }).then((input) => {
        conn = RockSSE.start({
          input: input,
          url: "/examples/progress-with-input",
          messageThrottle: 250, // 250ms
          onmessage: (msg) => {
            const cnt = parseInt(msg);

            current.innerText = cnt;
            // progress.value = (cnt / 100).toString();
          },
          onerror: (event) => {
            isRunning = false;
          },
        });
      });
    });

    // handle clicks on stop button
    stop.addEventListener("click", (e) => {
      // prevent stopping stream more than once
      if (!isRunning) return;
      isRunning = false;

      // close connection
      conn.close();

      // update text
      current.innerText = 0;
      progress.value = 0;
    });
  })();
</script>
